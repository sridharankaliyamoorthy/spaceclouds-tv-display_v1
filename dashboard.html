<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Space Clouds - Usage Analytics Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(160deg, #0a0e14 0%, #131920 40%, #0d1117 100%);
      color: #e6edf3;
      padding: 24px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 2px solid #30363d;
    }

    h1 {
      font-size: 2rem;
      color: #fff;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #7ee787;
      font-size: 1rem;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    button {
      background: #238636;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: background 0.2s;
    }

    button:hover {
      background: #2ea043;
    }

    button.secondary {
      background: #21262d;
      border: 1px solid #30363d;
    }

    button.secondary:hover {
      background: #30363d;
    }

    button.danger {
      background: #da3633;
    }

    button.danger:hover {
      background: #f85149;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 20px;
    }

    .stat-card h3 {
      font-size: 0.85rem;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #7ee787;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #b1bac4;
    }

    .section {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .section h2 {
      font-size: 1.3rem;
      color: #58a6ff;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid #30363d;
    }

    .screen-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .screen-card {
      background: #0d1117;
      border: 1px solid #21262d;
      border-radius: 8px;
      padding: 20px;
    }

    .screen-card h3 {
      font-size: 1.1rem;
      color: #79c0ff;
      margin-bottom: 16px;
      text-transform: capitalize;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #21262d;
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-row-label {
      color: #b1bac4;
    }

    .stat-row-value {
      color: #7ee787;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #21262d;
    }

    th {
      background: #21262d;
      color: #58a6ff;
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
    }

    td {
      color: #b1bac4;
      font-size: 0.9rem;
    }

    tr:hover {
      background: #0d1117;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6e7681;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .time-filter {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .time-filter button {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .time-filter button.active {
      background: #1f6feb;
    }

    .time-filter button.active:hover {
      background: #2563eb;
    }

    .alert {
      background: rgba(210, 153, 34, 0.15);
      border: 1px solid rgba(210, 153, 34, 0.3);
      color: #e3b341;
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .chart-container {
      margin-top: 20px;
      height: 300px;
      position: relative;
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 12px;
      height: 250px;
      padding: 20px 0;
    }

    .bar {
      flex: 1;
      background: linear-gradient(to top, #238636, #2ea043);
      border-radius: 4px 4px 0 0;
      position: relative;
      min-height: 20px;
      transition: opacity 0.2s;
    }

    .bar:hover {
      opacity: 0.8;
    }

    .bar-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8rem;
      color: #8b949e;
      white-space: nowrap;
    }

    .bar-value {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.85rem;
      color: #7ee787;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä Space Clouds Usage Analytics</h1>
      <p class="subtitle">Track and analyze TV display screen usage at the bar</p>
    </header>

    <div class="controls">
      <button onclick="refreshData()">üîÑ Refresh Data</button>
      <button onclick="exportJSON()" class="secondary">üì• Export JSON</button>
      <button onclick="exportCSV()" class="secondary">üìä Export CSV</button>
      <button onclick="clearData()" class="danger">üóëÔ∏è Clear All Data</button>
    </div>

    <div id="no-data-alert" class="alert" style="display: none;">
      ‚ö†Ô∏è No analytics data found. Data will appear once the TV screens are used.
    </div>

    <!-- Overview Stats -->
    <div class="stats-grid" id="overview-stats"></div>

    <!-- Screen Breakdown -->
    <div class="section">
      <h2>üì∫ Screen Performance</h2>
      <div class="screen-stats" id="screen-stats"></div>
    </div>

    <!-- Daily Usage -->
    <div class="section">
      <h2>üìÖ Daily Usage</h2>
      <div class="time-filter">
        <button onclick="filterByTime('all')" class="active" id="filter-all">All Time</button>
        <button onclick="filterByTime('today')" id="filter-today">Today</button>
        <button onclick="filterByTime('week')" id="filter-week">This Week</button>
        <button onclick="filterByTime('month')" id="filter-month">This Month</button>
      </div>
      <div class="chart-container">
        <div class="bar-chart" id="daily-chart"></div>
      </div>
    </div>

    <!-- Recent Events -->
    <div class="section">
      <h2>üïê Recent Activity</h2>
      <table id="recent-events">
        <thead>
          <tr>
            <th>Time</th>
            <th>Screen</th>
            <th>Event</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="events-tbody"></tbody>
      </table>
    </div>
  </div>

  <script src="analytics.js"></script>
  <script>
    let currentTimeFilter = 'all';
    let analyticsData = null;

    function refreshData() {
      if (window.SpaceCloudsAnalytics) {
        analyticsData = window.SpaceCloudsAnalytics.getData();
        renderDashboard();
      } else {
        console.error('Analytics not loaded');
      }
    }

    function renderDashboard() {
      if (!analyticsData || analyticsData.events.length === 0) {
        document.getElementById('no-data-alert').style.display = 'block';
        document.getElementById('overview-stats').innerHTML = '';
        document.getElementById('screen-stats').innerHTML = '';
        document.getElementById('daily-chart').innerHTML = '';
        document.getElementById('events-tbody').innerHTML = '<tr><td colspan="4" class="empty-state">No data available</td></tr>';
        return;
      }

      document.getElementById('no-data-alert').style.display = 'none';
      renderOverviewStats();
      renderScreenStats();
      renderDailyChart();
      renderRecentEvents();
    }

    function renderOverviewStats() {
      const totals = analyticsData.totals;
      const totalViews = totals.left.views + totals.center.views + totals.right.views;
      const totalPlays = totals.left.videoPlays + totals.center.videoPlays + totals.right.videoPlays;
      const totalDuration = totals.left.totalDuration + totals.center.totalDuration + totals.right.totalDuration;
      const totalEvents = analyticsData.events.length;
      const uniqueDays = getUniqueDays(analyticsData.events);

      const html = `
        <div class="stat-card">
          <h3>Total Page Views</h3>
          <div class="stat-value">${totalViews.toLocaleString()}</div>
          <div class="stat-label">Across all screens</div>
        </div>
        <div class="stat-card">
          <h3>Video Plays</h3>
          <div class="stat-value">${totalPlays.toLocaleString()}</div>
          <div class="stat-label">Total play events</div>
        </div>
        <div class="stat-card">
          <h3>Total Playback Time</h3>
          <div class="stat-value">${formatDuration(totalDuration)}</div>
          <div class="stat-label">Hours of content</div>
        </div>
        <div class="stat-card">
          <h3>Active Days</h3>
          <div class="stat-value">${uniqueDays}</div>
          <div class="stat-label">Days with activity</div>
        </div>
        <div class="stat-card">
          <h3>Total Events</h3>
          <div class="stat-value">${totalEvents.toLocaleString()}</div>
          <div class="stat-label">All tracked events</div>
        </div>
      `;

      document.getElementById('overview-stats').innerHTML = html;
    }

    function renderScreenStats() {
      const totals = analyticsData.totals;
      const screens = ['left', 'center', 'right'];
      
      const html = screens.map(screen => {
        const stats = totals[screen];
        const avgDuration = stats.videoPlays > 0 ? stats.totalDuration / stats.videoPlays : 0;
        
        return `
          <div class="screen-card">
            <h3>${screen} Screen</h3>
            <div class="stat-row">
              <span class="stat-row-label">Page Views</span>
              <span class="stat-row-value">${stats.views.toLocaleString()}</span>
            </div>
            <div class="stat-row">
              <span class="stat-row-label">Video Plays</span>
              <span class="stat-row-value">${stats.videoPlays.toLocaleString()}</span>
            </div>
            <div class="stat-row">
              <span class="stat-row-label">Total Playback</span>
              <span class="stat-row-value">${formatDuration(stats.totalDuration)}</span>
            </div>
            <div class="stat-row">
              <span class="stat-row-label">Avg Play Duration</span>
              <span class="stat-row-value">${formatDuration(avgDuration)}</span>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('screen-stats').innerHTML = html;
    }

    function renderDailyChart() {
      const filteredEvents = filterEventsByTime(analyticsData.events, currentTimeFilter);
      const dailyData = getDailyStats(filteredEvents);
      
      if (dailyData.length === 0) {
        document.getElementById('daily-chart').innerHTML = '<div class="empty-state">No data for selected period</div>';
        return;
      }

      const maxValue = Math.max(...dailyData.map(d => d.views));
      
      const html = dailyData.map(day => {
        const height = maxValue > 0 ? (day.views / maxValue) * 100 : 0;
        return `
          <div class="bar" style="height: ${height}%">
            <div class="bar-value">${day.views}</div>
            <div class="bar-label">${day.date}</div>
          </div>
        `;
      }).join('');

      document.getElementById('daily-chart').innerHTML = html;
    }

    function renderRecentEvents() {
      const filteredEvents = filterEventsByTime(analyticsData.events, currentTimeFilter);
      const recent = filteredEvents.slice(-50).reverse(); // Last 50, newest first
      
      if (recent.length === 0) {
        document.getElementById('events-tbody').innerHTML = '<tr><td colspan="4" class="empty-state">No events for selected period</td></tr>';
        return;
      }

      const html = recent.map(event => {
        const time = new Date(event.timestamp);
        return `
          <tr>
            <td>${time.toLocaleString()}</td>
            <td><strong>${event.screen}</strong></td>
            <td>${formatEventType(event.type)}</td>
            <td>${formatEventDetails(event)}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('events-tbody').innerHTML = html;
    }

    function filterByTime(period) {
      currentTimeFilter = period;
      
      // Update button states
      document.querySelectorAll('.time-filter button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`filter-${period}`).classList.add('active');
      
      renderDailyChart();
      renderRecentEvents();
    }

    function filterEventsByTime(events, period) {
      if (period === 'all') return events;
      
      const now = new Date();
      const cutoff = new Date();
      
      switch(period) {
        case 'today':
          cutoff.setHours(0, 0, 0, 0);
          break;
        case 'week':
          cutoff.setDate(now.getDate() - 7);
          break;
        case 'month':
          cutoff.setMonth(now.getMonth() - 1);
          break;
      }
      
      return events.filter(e => new Date(e.timestamp) >= cutoff);
    }

    function getDailyStats(events) {
      const dailyMap = {};
      
      events.forEach(event => {
        if (event.type === 'page_view') {
          const date = new Date(event.timestamp).toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
          });
          dailyMap[date] = (dailyMap[date] || 0) + 1;
        }
      });
      
      return Object.entries(dailyMap)
        .map(([date, views]) => ({ date, views }))
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(-14); // Last 14 days
    }

    function getUniqueDays(events) {
      const days = new Set();
      events.forEach(e => {
        const date = new Date(e.timestamp).toDateString();
        days.add(date);
      });
      return days.size;
    }

    function formatDuration(seconds) {
      if (!seconds || seconds === 0) return '0s';
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      if (hours > 0) {
        return `${hours}h ${minutes}m`;
      } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
      } else {
        return `${secs}s`;
      }
    }

    function formatEventType(type) {
      const types = {
        'page_view': 'üìÑ Page View',
        'video_play': '‚ñ∂Ô∏è Video Play',
        'video_pause': '‚è∏Ô∏è Video Pause',
        'video_loop': 'üîÅ Video Loop',
        'video_loaded': 'üì¶ Video Loaded',
        'video_error': '‚ùå Video Error',
        'session_start': 'üöÄ Session Start',
        'session_end': 'üèÅ Session End',
        'session_pause': '‚è∏Ô∏è Session Pause',
        'session_resume': '‚ñ∂Ô∏è Session Resume',
        'fullscreen_change': 'üî≤ Fullscreen',
        'heartbeat': 'üíì Heartbeat'
      };
      return types[type] || type;
    }

    function formatEventDetails(event) {
      const details = [];
      if (event.duration) details.push(`Duration: ${formatDuration(event.duration)}`);
      if (event.loopCount) details.push(`Loop #${event.loopCount}`);
      if (event.sessionId) details.push(`Session: ${event.sessionId.substr(0, 8)}...`);
      if (event.isFullscreen !== undefined) details.push(event.isFullscreen ? 'Entered' : 'Exited');
      return details.join(' ¬∑ ') || '-';
    }

    function exportJSON() {
      if (!analyticsData) {
        alert('No data to export');
        return;
      }
      
      const dataStr = JSON.stringify(analyticsData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `spaceclouds-analytics-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function exportCSV() {
      if (!analyticsData || analyticsData.events.length === 0) {
        alert('No data to export');
        return;
      }
      
      const headers = ['Timestamp', 'Screen', 'Event Type', 'Session ID', 'Duration', 'Details'];
      const rows = analyticsData.events.map(e => [
        e.timestamp,
        e.screen,
        e.type,
        e.sessionId || '',
        e.duration || '',
        JSON.stringify(e).replace(/"/g, '""')
      ]);
      
      const csv = [
        headers.join(','),
        ...rows.map(r => r.map(cell => `"${cell}"`).join(','))
      ].join('\n');
      
      const dataBlob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `spaceclouds-analytics-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function clearData() {
      if (confirm('Are you sure you want to clear all analytics data? This cannot be undone.')) {
        if (window.SpaceCloudsAnalytics) {
          window.SpaceCloudsAnalytics.clearData();
          refreshData();
          alert('All data has been cleared.');
        }
      }
    }

    // Initial load
    refreshData();
    
    // Auto-refresh every 30 seconds
    setInterval(refreshData, 30000);
  </script>
</body>
</html>
